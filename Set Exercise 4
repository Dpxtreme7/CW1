/* SET EXERCISE 4: SQL IMPLEMENTATION 
   Schema: CW1
   Description: Creates tables for TrailService and populates with sample data.
*/

-- 1. Create Schema 
IF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'CW1')
BEGIN
    EXEC('CREATE SCHEMA [CW1]')
END
GO

-- 2. Drop tables if they exist (Clean slate for re-running)
DROP TABLE IF EXISTS CW1.TrailLog;
DROP TABLE IF EXISTS CW1.TrailFeature;
DROP TABLE IF EXISTS CW1.TrailLocations;
DROP TABLE IF EXISTS CW1.Trails;
DROP TABLE IF EXISTS CW1.Feature;
DROP TABLE IF EXISTS CW1.RouteType;
DROP TABLE IF EXISTS CW1.Users;
GO

-- 3. Create Tables

-- Table: USERS
CREATE TABLE CW1.Users (
    UserID INT IDENTITY(1,1) PRIMARY KEY,
    FullName NVARCHAR(100) NOT NULL,
    Email NVARCHAR(100) UNIQUE NOT NULL,
    Role NVARCHAR(50) DEFAULT 'User'
);

-- Table: ROUTE_TYPE
CREATE TABLE CW1.RouteType (
    RouteTypeID INT IDENTITY(1,1) PRIMARY KEY,
    RouteTypeName NVARCHAR(50) NOT NULL
);

-- Table: FEATURE
CREATE TABLE CW1.Feature (
    FeatureID INT IDENTITY(1,1) PRIMARY KEY,
    FeatureName NVARCHAR(100) NOT NULL
);

-- Table: TRAIL
CREATE TABLE CW1.Trails (
    TrailID INT IDENTITY(1,1) PRIMARY KEY,
    TrailName NVARCHAR(200) NOT NULL,
    TrailSummary NVARCHAR(MAX),
    TrailDescription NVARCHAR(MAX),
    Difficulty NVARCHAR(50),
    Location NVARCHAR(100),
    LengthKm DECIMAL(5,2),
    OwnerID INT NOT NULL,
    RouteTypeID INT NOT NULL,
    CreatedAt DATETIME DEFAULT GETDATE(),
    
    CONSTRAINT FK_Trails_Owner FOREIGN KEY (OwnerID) REFERENCES CW1.Users(UserID),
    CONSTRAINT FK_Trails_RouteType FOREIGN KEY (RouteTypeID) REFERENCES CW1.RouteType(RouteTypeID)
);

-- Table: TRAIL_LOCATIONS
CREATE TABLE CW1.TrailLocations (
    TrailID INT NOT NULL,
    OrderSequence INT NOT NULL,
    Latitude DECIMAL(9,6) NOT NULL,
    Longitude DECIMAL(9,6) NOT NULL,
    
    CONSTRAINT PK_TrailLocations PRIMARY KEY (TrailID, OrderSequence),
    CONSTRAINT FK_TrailLocations_Trail FOREIGN KEY (TrailID) REFERENCES CW1.Trails(TrailID)
);

-- Table: TRAIL_FEATURE (Link Table)
CREATE TABLE CW1.TrailFeature (
    TrailID INT NOT NULL,
    FeatureID INT NOT NULL,
    
    CONSTRAINT PK_TrailFeature PRIMARY KEY (TrailID, FeatureID),
    CONSTRAINT FK_TrailFeature_Trail FOREIGN KEY (TrailID) REFERENCES CW1.Trails(TrailID),
    CONSTRAINT FK_TrailFeature_Feature FOREIGN KEY (FeatureID) REFERENCES CW1.Feature(FeatureID)
);

-- Table: TRAIL_LOG (For Set Exercise 7)
CREATE TABLE CW1.TrailLog (
    LogID INT IDENTITY(1,1) PRIMARY KEY,
    TrailID INT,
    Action NVARCHAR(50),
    LogDate DATETIME DEFAULT GETDATE(),
    UserPerformed NVARCHAR(100)
);
GO

-- 4. Insert Sample Data 

-- Users
INSERT INTO CW1.Users (FullName, Email, Role) VALUES 
('Ada Lovelace', 'grace@plymouth.ac.uk', 'Admin'),
('Tim Berners-Lee', 'tim@plymouth.ac.uk', 'User'),
('Ada Lovelace', 'ada@plymouth.ac.uk', 'User');

-- Route Types
INSERT INTO CW1.RouteType (RouteTypeName) VALUES ('Circular'), ('Point-to-Point'), ('Loop');

-- Features
INSERT INTO CW1.Feature (FeatureName) VALUES ('Waterfall'), ('Dog Friendly'), ('Scenic View'), ('Pub Nearby');

-- Trails
INSERT INTO CW1.Trails (TrailName, TrailSummary, Difficulty, Location, LengthKm, OwnerID, RouteTypeID) VALUES 
('Plymbridge Circular', 'A scenic route through the woods.', 'Moderate', 'Devon', 5.4, 1, 1),
('Dartmoor Tors', 'Challenging hike with views.', 'Hard', 'Dartmoor', 12.5, 2, 2);

-- Trail Locations (Plymbridge)
INSERT INTO CW1.TrailLocations (TrailID, OrderSequence, Latitude, Longitude) VALUES 
(1, 1, 50.4146, -4.0737),
(1, 2, 50.4150, -4.0740),
(1, 3, 50.4160, -4.0750);

-- Trail Locations (Dartmoor)
INSERT INTO CW1.TrailLocations (TrailID, OrderSequence, Latitude, Longitude) VALUES 
(2, 1, 50.5500, -4.0000),
(2, 2, 50.5600, -4.0100);

-- Trail Features
INSERT INTO CW1.TrailFeature (TrailID, FeatureID) VALUES 
(1, 1), -- Plymbridge has Waterfall
(1, 2), -- Plymbridge is Dog Friendly
(2, 3); -- Dartmoor has Scenic View
GO

-- 5. Verify Data 
SELECT * FROM CW1.Trails;
SELECT * FROM CW1.TrailLocations;
